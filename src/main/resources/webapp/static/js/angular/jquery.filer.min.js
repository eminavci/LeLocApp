!function(e){"use strict";e.fn.filer=function(t){return this.each(function(i,n){var r=e(n),a=".jFiler",l=e(),o=e(),s=e(),f=[],d=e.extend(!0,{},e.fn.filer.defaults,t),u={init:function(){r.wrap('<div class="jFiler"></div>'),r.prop("jFiler").boxEl=l=r.closest(a),u._changeInput()},_bindInput:function(){d.changeInput&&o.size()>0&&o.bind("click",u._clickHandler),r.on({focus:function(){o.addClass("focused")},blur:function(){o.removeClass("focused")},change:function(){u._onChange()}}),d.dragDrop&&(o.length>0?o:r).bind("drop",u._dragDrop.drop).bind("dragover",u._dragDrop.dragEnter).bind("dragleave",u._dragDrop.dragLeave),d.uploadFile&&d.clipBoardPaste&&e(window).on("paste",u._clipboardPaste)},_unbindInput:function(){d.changeInput&&o.size()>0&&o.unbind("click",u._clickHandler)},_clickHandler:function(){r.click()},_applyAttrSettings:function(){var e=["name","limit","maxSize","extensions","changeInput","showThumbs","appendTo","theme","addMore","excludeName","files","options"];for(var t in e){var i="data-jfiler-"+e[t];if(u._assets.hasAttr(i)){switch(e[t]){case"changeInput":case"showThumbs":case"addMore":d[e[t]]=["true","false"].indexOf(r.attr(i))>-1?"true"==r.attr(i):r.attr(i);break;case"extensions":d[e[t]]=r.attr(i).replace(/ /g,"").split(",");break;case"files":case"options":d[e[t]]=JSON.parse(r.attr(i));break;default:d[e[t]]=r.attr(i)}r.removeAttr(i)}}},_changeInput:function(){if(u._applyAttrSettings(),null!=d.beforeRender&&"function"==typeof d.beforeRender?d.beforeRender(l,r):null,d.theme&&l.addClass("jFiler-theme-"+d.theme),"input"!=r.get(0).tagName.toLowerCase()&&"file"!=r.get(0).type)o=r,r=e('<input type="file" name="'+d.name+'" />'),r.css({position:"absolute",left:"-9999px",top:"-9999px","z-index":"-9999"}),l.prepend(r),u._isGn=r;else if(d.changeInput){switch(typeof d.changeInput){case"boolean":o=e('<div class="jFiler-input"><div class="jFiler-input-caption"><span>'+d.captions.feedback+'</span></div><div class="jFiler-input-button">'+d.captions.button+'</div></div>"');break;case"string":case"object":o=e(d.changeInput);break;case"function":o=e(d.changeInput(l,r,d))}r.after(o),r.css({position:"absolute",left:"-9999px",top:"-9999px","z-index":"-9999"})}r.prop("jFiler").newInputEl=o,(!d.limit||d.limit&&d.limit>=2)&&(r.attr("multiple","multiple"),"[]"!=r.attr("name").slice(-2)?r.attr("name",r.attr("name")+"[]"):null),u._bindInput(),d.files&&u._append(!1,{files:d.files}),null!=d.afterRender&&"function"==typeof d.afterRender?d.afterRender(s,l,o,r):null},_clear:function(){u.files=null,r.prop("jFiler").files=null,d.uploadFile||d.addMore||u._reset(),u._set("feedback",u._itFl&&u._itFl.length>0?u._itFl.length+" "+d.captions.feedback2:d.captions.feedback),null!=d.onEmpty&&"function"==typeof d.onEmpty?d.onEmpty(l,o,r):null},_reset:function(t){if(!t){if(!d.uploadFile&&d.addMore){for(var i=0;i<f.length;i++)f[i].remove();f=[],u._unbindInput(),r=u._isGn?u._isGn:e(n),u._bindInput()}u._set("input","")}u._itFl=[],u._itFc=null,u._ajFc=0,r.prop("jFiler").files_list=u._itFl,r.prop("jFiler").current_file=u._itFc,u._prEr||(u._itFr=[],l.find("input[name^='jfiler-items-exclude-']:hidden").remove()),s.fadeOut("fast",function(){e(this).remove()}),r.prop("jFiler").listEl=s=e()},_set:function(e,t){switch(e){case"input":r.val("");break;case"feedback":o.length>0&&o.find(".jFiler-input-caption span").html(t)}},_filesCheck:function(){var t=0;if(d.limit&&u.files.length+u._itFl.length>d.limit)return alert(u._assets.textParse(d.captions.errors.filesLimit)),!1;for(var i=0;i<u.files.length;i++){var n=u.files[i].name.split(".").pop().toLowerCase(),r=u.files[i],a={name:r.name,size:r.size,size2:u._assets.bytesToSize(r.size),type:r.type,ext:n};if(null!=d.extensions&&-1==e.inArray(n,d.extensions))return alert(u._assets.textParse(d.captions.errors.filesType,a)),!1;if(null!=d.maxSize&&u.files[i].size>1048576*d.maxSize)return alert(u._assets.textParse(d.captions.errors.filesSize,a)),!1;if(4096==r.size&&0==r.type.length)return!1;t+=u.files[i].size}if(null!=d.maxSize&&t>=Math.round(1048576*d.maxSize))return alert(u._assets.textParse(d.captions.errors.filesSizeAll)),!1;if(d.addMore||d.uploadFile){var a=u._itFl.filter(function(e,t){return e.file.name!=r.name||e.file.size!=r.size||e.file.type!=r.type||(r.lastModified?e.file.lastModified!=r.lastModified:0)?void 0:!0});if(a.length>0)return!1}return!0},_thumbCreator:{create:function(t){var i=u.files[t],n=u._itFc?u._itFc.id:t,r=i.name,a=i.size,l=i.type.split("/",1).toString().toLowerCase(),o=-1!=r.indexOf(".")?r.split(".").pop().toLowerCase():"",f=d.uploadFile?'<div class="jFiler-jProgressBar">'+d.templates.progressBar+"</div>":"",p={id:n,name:r,size:a,size2:u._assets.bytesToSize(a),type:l,extension:o,icon:u._assets.getIcon(o,l),icon2:u._thumbCreator.generateIcon({type:l,extension:o}),image:'<div class="jFiler-item-thumb-image fi-loading"></div>',progressBar:f,_appended:i._appended},c="";return i.opts&&(p=e.extend({},i.opts,p)),c=e(u._thumbCreator.renderContent(p)).attr("data-jfiler-index",n),c.get(0).jfiler_id=n,u._thumbCreator.renderFile(i,c,p),i.forList?c:(u._itFc.html=c,c.hide()[d.templates.itemAppendToEnd?"appendTo":"prependTo"](s.find(d.templates._selectors.list)).show(),void(i._appended||u._onSelect(t)))},renderContent:function(e){return u._assets.textParse(e._appended?d.templates.itemAppend:d.templates.item,e)},renderFile:function(t,i,n){if(0==i.find(".jFiler-item-thumb-image").size())return!1;if(t.file&&"image"==n.type){var r='<img src="'+t.file+'" draggable="false" />',a=i.find(".jFiler-item-thumb-image.fi-loading");return e(r).error(function(){r=u._thumbCreator.generateIcon(n),i.addClass("jFiler-no-thumbnail"),a.removeClass("fi-loading").html(r)}).load(function(){a.removeClass("fi-loading").html(r)}),!0}if(window.File&&window.FileList&&window.FileReader&&"image"==n.type&&n.size<6e6){var l=new FileReader;l.onload=function(t){var r='<img src="'+t.target.result+'" draggable="false" />',a=i.find(".jFiler-item-thumb-image.fi-loading");e(r).error(function(){r=u._thumbCreator.generateIcon(n),i.addClass("jFiler-no-thumbnail"),a.removeClass("fi-loading").html(r)}).load(function(){a.removeClass("fi-loading").html(r)})},l.readAsDataURL(t)}else{var r=u._thumbCreator.generateIcon(n),a=i.find(".jFiler-item-thumb-image.fi-loading");i.addClass("jFiler-no-thumbnail"),a.removeClass("fi-loading").html(r)}},generateIcon:function(t){var i=new Array(3);if(t&&t.type&&t.extension)switch(t.type){case"image":i[0]="f-image",i[1]='<i class="icon-jfi-file-image"></i>';break;case"video":i[0]="f-video",i[1]='<i class="icon-jfi-file-video"></i>';break;case"audio":i[0]="f-audio",i[1]='<i class="icon-jfi-file-audio"></i>';break;default:i[0]="f-file f-file-ext-"+t.extension,i[1]=t.extension.length>0?"."+t.extension:"",i[2]=1}else i[0]="f-file",i[1]=t.extension&&t.extension.length>0?"."+t.extension:"",i[2]=1;var n='<span class="jFiler-icon-file '+i[0]+'">'+i[1]+"</span>";if(1==i[2]){var r=u._assets.text2Color(t.extension);if(r){var a=e(n).appendTo("body"),l=a.css("box-shadow");l=r+l.substring(l.replace(/^.*(rgba?\([^)]+\)).*$/,"$1").length,l.length),a.css({"-webkit-box-shadow":l,"-moz-box-shadow":l,"box-shadow":l}).attr("style","-webkit-box-shadow: "+l+"; -moz-box-shadow: "+l+"; box-shadow: "+l+";"),n=a.prop("outerHTML"),a.remove()}}return n},_box:function(t){if(null!=d.beforeShow&&"function"==typeof d.beforeShow?!d.beforeShow(u.files,s,l,o,r):!1)return!1;if(s.length<1){if(d.appendTo)var i=e(d.appendTo);else var i=l;i.find(".jFiler-items").remove(),s=e('<div class="jFiler-items jFiler-row"></div>'),r.prop("jFiler").listEl=s,s.append(u._assets.textParse(d.templates.box)).appendTo(i),s.on("click",d.templates._selectors.remove,function(i){i.preventDefault();var n=d.templates.removeConfirmation?confirm(d.captions.removeConfirmation):!0;n&&u._remove(t?t.remove.event:i,t?t.remove.el:e(this).closest(d.templates._selectors.item))})}for(var n=0;n<u.files.length;n++)u.files[n]._appended||(u.files[n]._choosed=!0),u._addToMemory(n),u._thumbCreator.create(n)}},_upload:function(t){var i=u._itFc.html,n=new FormData;if(n.append(r.attr("name"),u._itFc.file,u._itFc.file.name?u._itFc.file.name:!1),null!=d.uploadFile.data&&e.isPlainObject(d.uploadFile.data))for(var a in d.uploadFile.data)n.append(a,d.uploadFile.data[a]);u._ajax.send(i,n,u._itFc)},_ajax:{send:function(t,i,n){return n.ajax=e.ajax({url:d.uploadFile.url,data:i,type:d.uploadFile.type,enctype:d.uploadFile.enctype,xhr:function(){var i=e.ajaxSettings.xhr();return i.upload&&i.upload.addEventListener("progress",function(e){u._ajax.progressHandling(e,t)},!1),i},complete:function(e,t){n.ajax=!1,u._ajFc++,u._ajFc>=u.files.length&&(u._ajFc=0,null!=d.uploadFile.onComplete&&"function"==typeof d.uploadFile.onComplete?d.uploadFile.onComplete(s,l,o,r,e,t):null)},beforeSend:function(e,i){return null!=d.uploadFile.beforeSend&&"function"==typeof d.uploadFile.beforeSend?d.uploadFile.beforeSend(t,s,l,o,r,n.id,e,i):!0},success:function(e,i,a){n.uploaded=!0,null!=d.uploadFile.success&&"function"==typeof d.uploadFile.success?d.uploadFile.success(e,t,s,l,o,r,n.id,i,a):null},error:function(e,i,a){n.uploaded=!1,null!=d.uploadFile.error&&"function"==typeof d.uploadFile.error?d.uploadFile.error(t,s,l,o,r,n.id,e,i,a):null},statusCode:d.uploadFile.statusCode,cache:!1,contentType:!1,processData:!1}),n.ajax},progressHandling:function(e,t){if(e.lengthComputable){var i=Math.round(100*e.loaded/e.total).toString();null!=d.uploadFile.onProgress&&"function"==typeof d.uploadFile.onProgress?d.uploadFile.onProgress(i,t,s,l,o,r):null,t.find(".jFiler-jProgressBar").find(d.templates._selectors.progressBar).css("width",i+"%")}}},_dragDrop:{dragEnter:function(e){e.preventDefault(),e.stopPropagation(),l.addClass("dragged"),u._set("feedback",d.captions.drop),null!=d.dragDrop.dragEnter&&"function"==typeof d.dragDrop.dragEnter?d.dragDrop.dragEnter(e,o,r,l):null},dragLeave:function(e){return e.preventDefault(),e.stopPropagation(),u._dragDrop._dragLeaveCheck(e)?(l.removeClass("dragged"),u._set("feedback",d.captions.feedback),void(null!=d.dragDrop.dragLeave&&"function"==typeof d.dragDrop.dragLeave?d.dragDrop.dragLeave(e,o,r,l):null)):!1},drop:function(e){e.preventDefault(),l.removeClass("dragged"),!e.originalEvent.dataTransfer.files||e.originalEvent.dataTransfer.files.length<=0||(u._set("feedback",d.captions.feedback),u._onChange(e,e.originalEvent.dataTransfer.files),null!=d.dragDrop.drop&&"function"==typeof d.dragDrop.drop?d.dragDrop.drop(e.originalEvent.dataTransfer.files,e,o,r,l):null)},_dragLeaveCheck:function(t){var i=t.relatedTarget,n=!1;return i!==o&&(i&&(n=e.contains(o,i)),n)?!1:!0}},_clipboardPaste:function(e,t){if((t||e.originalEvent.clipboardData||e.originalEvent.clipboardData.items)&&(!t||e.originalEvent.dataTransfer||e.originalEvent.dataTransfer.items)&&!u._clPsePre){var i=t?e.originalEvent.dataTransfer.items:e.originalEvent.clipboardData.items,n=function(e,t,i){t=t||"",i=i||512;for(var n=atob(e),r=[],a=0;a<n.length;a+=i){for(var l=n.slice(a,a+i),o=new Array(l.length),s=0;s<l.length;s++)o[s]=l.charCodeAt(s);var f=new Uint8Array(o);r.push(f)}var d=new Blob(r,{type:t});return d};if(i)for(var r=0;r<i.length;r++)if(-1!==i[r].type.indexOf("image")||-1!==i[r].type.indexOf("text/uri-list")){if(t)try{window.atob(e.originalEvent.dataTransfer.getData("text/uri-list").toString().split(",")[1])}catch(e){return}var a=t?n(e.originalEvent.dataTransfer.getData("text/uri-list").toString().split(",")[1],"image/png"):i[r].getAsFile();a.name=Math.random().toString(36).substring(5),a.name+=-1!=a.type.indexOf("/")?"."+a.type.split("/")[1].toString().toLowerCase():".png",u._onChange(e,[a]),u._clPsePre=setTimeout(function(){delete u._clPsePre},1e3)}}},_onSelect:function(t){d.uploadFile&&!e.isEmptyObject(d.uploadFile)&&u._upload(t),null!=d.onSelect&&"function"==typeof d.onSelect?d.onSelect(u.files[t],u._itFc.html,s,l,o,r):null,t+1>=u.files.length&&(null!=d.afterShow&&"function"==typeof d.afterShow?d.afterShow(s,l,o,r):null)},_onChange:function(t,i){if(i){if(!i||0==i.length)return u._set("input",""),u._clear(),!1;u.files=i}else{if(!r.get(0).files||"undefined"==typeof r.get(0).files||0==r.get(0).files.length)return d.uploadFile||d.addMore||(u._set("input",""),u._clear()),!1;u.files=r.get(0).files}if(d.uploadFile||d.addMore||u._reset(!0),r.prop("jFiler").files=u.files,!u._filesCheck()||(null!=d.beforeSelect&&"function"==typeof d.beforeSelect?!d.beforeSelect(u.files,s,l,o,r):!1))return u._set("input",""),u._clear(),!1;if(u._set("feedback",u.files.length+u._itFl.length+" "+d.captions.feedback2),d.showThumbs)u._thumbCreator._box();else for(var n=0;n<u.files.length;n++)u.files[n]._choosed=!0,u._addToMemory(n),u._onSelect(n);if(!d.uploadFile&&d.addMore){var a=e('<input type="file" />'),p=r.prop("attributes");e.each(p,function(){a.attr(this.name,this.value)}),r.after(a),u._unbindInput(),f.push(a),r=a,u._bindInput()}},_append:function(e,t){var i=t?t.files:!1;if(i&&!(i.length<=0)&&(u.files=i,r.prop("jFiler").files=u.files,d.showThumbs)){for(var n=0;n<u.files.length;n++)u.files[n]._appended=!0;u._thumbCreator._box()}},_getList:function(e,t){var i=t?t.files:!1;if(i&&!(i.length<=0)&&(u.files=i,r.prop("jFiler").files=u.files,d.showThumbs)){for(var n=[],a=0;a<u.files.length;a++)u.files[a].forList=!0,n.push(u._thumbCreator.create(a));t.callback&&t.callback(n,s,l,o,r)}},_retryUpload:function(t,i){var n=parseInt("object"==typeof i?i.attr("data-jfiler-index"):i),a=u._itFl.filter(function(e,t){return e.id==n});return a.length>0?!d.uploadFile||e.isEmptyObject(d.uploadFile)||a[0].uploaded?void 0:(u._itFc=a[0],r.prop("jFiler").current_file=u._itFc,u._upload(n),!0):!1},_remove:function(t,n){if(n.binded){if("undefined"!=typeof n.data.id&&(n=s.find(d.templates._selectors.item+"[data-jfiler-index='"+n.data.id+"']"),0==n.size()))return!1;n.data.el&&(n=n.data.el)}var a=n.get(0).jfiler_id||n.attr("data-jfiler-index"),f=null,p=function(t){var n=l.find("input[name^='jfiler-items-exclude-']:hidden").first(),a=u._itFl[t],o=[];if(0==n.size()&&(n=e('<input type="hidden" name="jfiler-items-exclude-'+(d.excludeName?d.excludeName:("[]"!=r.attr("name").slice(-2)?r.attr("name"):r.attr("name").substring(0,r.attr("name").length-2))+"-"+i)+'">'),n.appendTo(l)),a.file._choosed||a.file._appended||a.uploaded){if(u._prEr=!0,u._itFr.push(a),d.addMore){var s=a.input,f=0;u._itFl.filter(function(e,t){e.file._choosed&&e.input.get(0)==s.get(0)&&f++}),1==f&&(u._itFr=u._itFr.filter(function(e,t){return e.file._choosed?e.input.get(0)!=s.get(0):!0}),s.val(""),u._prEr=!1)}for(var p=0;p<u._itFr.length;p++)o.push(u._itFr[p].file.name);o=JSON.stringify(o),n.val(o)}},c=function(t,i){p(i),u._itFl.splice(i,1),u._itFl.length<1?(u._reset(),u._clear()):u._set("feedback",u._itFl.length+" "+d.captions.feedback2),t.fadeOut("fast",function(){e(this).remove()})};for(var g in u._itFl)"length"!==g&&u._itFl.hasOwnProperty(g)&&u._itFl[g].id==a&&(f=g);return u._itFl.hasOwnProperty(f)?u._itFl[f].ajax?(u._itFl[f].ajax.abort(),void c(n,f)):(null!=d.onRemove&&"function"==typeof d.onRemove?d.onRemove(n,u._itFl[f].file,f,s,l,o,r):null,void c(n,f)):!1},_addToMemory:function(t){u._itFl.push({id:u._itFl.length,file:u.files[t],html:e(),ajax:!1,uploaded:!1}),d.addMore&&!u.files[t]._appended&&(u._itFl[u._itFl.length-1].input=r),u._itFc=u._itFl[u._itFl.length-1],r.prop("jFiler").files_list=u._itFl,r.prop("jFiler").current_file=u._itFc},_assets:{bytesToSize:function(e){if(0==e)return"0 Byte";var t=1e3,i=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(e)/Math.log(t));return(e/Math.pow(t,n)).toPrecision(3)+" "+i[n]},hasAttr:function(e,t){var t=t?t:r,i=t.attr(e);return i&&"undefined"!=typeof i?!0:!1},getIcon:function(t,i){var n=["audio","image","text","video"];return e.inArray(i,n)>-1?'<i class="icon-jfi-file-'+i+" jfi-file-ext-"+t+'"></i>':'<i class="icon-jfi-file-o jfi-file-type-'+i+" jfi-file-ext-"+t+'"></i>'},textParse:function(t,i){switch(i=e.extend({},{limit:d.limit,maxSize:d.maxSize,extensions:d.extensions?d.extensions.join(","):null},i&&e.isPlainObject(i)?i:{},d.options),typeof t){case"string":return t.replace(/\[\[fi-(.*?)\]\]/g,function(e,t){return t=t.replace(/ /g,""),t.match(/(.*?)\|limitTo\:(\d+)/)?t.replace(/(.*?)\|limitTo\:(\d+)/,function(e,t,n){var t=i[t]?i[t]:"",r=t.substring(0,n);return r=t.length>r.length?r.substring(0,r.length-3)+"...":r}):i[t]?i[t]:""});case"function":return t(i);default:return t}},text2Color:function(e){if(!e||0==e.length)return!1;for(var t=0,i=0;t<e.length;i=e.charCodeAt(t++)+((i<<5)-i));for(var t=0,n="#";3>t;n+=("00"+(i>>2*t++&255).toString(16)).slice(-2));return n}},files:null,_itFl:[],_itFc:null,_itFr:[],_ajFc:0,_prEr:!1};return r.prop("jFiler",{options:d,listEl:s,boxEl:l,newInputEl:o,inputEl:r,files:u.files,files_list:u._itFl,current_file:u._itFc,append:function(e){return u._append(!1,{files:[e]})},remove:function(e){return u._remove(null,{binded:!0,data:{id:e}}),!0},reset:function(){return u._reset(),u._clear(),!0},retry:function(e){return u._retryUpload(e)}}).on("filer.append",function(e,t){u._append(e,t)}).on("filer.remove",function(e,t){t.binded=!0,u._remove(e,t)}).on("filer.reset",function(e){return u._reset(),u._clear(),!0}).on("filer.generateList",function(e,t){return u._getList(e,t)}).on("filer.retry",function(e,t){return u._retryUpload(e,t)}),u.init(),this})}}(jQuery);